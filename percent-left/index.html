<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='UTF-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<meta name="description" content="2027年まであと何%なのかを表示します。他の年も設定できます。">

		<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-G3VRHWGPB7"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-G3VRHWGPB7');
	</script>

	<!-- Color picker:
		I used Pickr(https://github.com/Simonwep/pickr?tab=readme-ov-file).
		A big thank you to simonwep. -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr@1.8.2/dist/themes/monolith.min.css">
	<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr@1.8.2/dist/pickr.min.js"></script>

	<title>2027年まであと何%？</title>
	<style>
		@font-face {
			font-family: "originalFont";
			src: url(/0_data/fonts/MPLUS1p-Regular.ttf) format("truetype");
			/* src: url(https://u-12031.github.io//0_data/fonts/MPLUS1p-Regular.ttf); */
			/* ↑codeswing用 */
		}

		@font-face {
			font-family: "7segFont";
			src: url(/0_data/fonts/fonts-DSEG_v046/DSEG7ClassicMini-Bold.ttf) format("truetype");
			/* src: url(https://u-12031.github.io//0_data/fonts/fonts-DSEG_v046/DSEG7ClassicMini-Bold.ttf); */
			/* ↑codeswing用 */
		}

		* {
			text-align: center;
			font-family: "originalFont";
		}

		body {margin: 0;}

		input[type="checkbox"] {
			appearance: none;
			position: relative;
			margin: 5px auto;
			margin-bottom: -5px;
			width: 40px;
			height: 25px;
			border-radius: 12.5px;
			background-color: #999;
			transition: all .2s;
				
			&:checked {background-color: #0af;}

			&::after {
				margin: 0;
				content: "";
				position: absolute;
				top: 2px;
				left: 2px;
				width: 21px;
				height: 21px;
				border-radius: 50%;
				background-color: #fff;
				transition: all .2s;
			}

			&:checked::after {
				left: 17px;
			}

		}

		.pickr {
			display: inline-block;
			margin: 5px;
		}

		#title>#timeFor {
			font-size: inherit;
			padding: 0;
			padding-right: 5px;
			margin-right: -5px;
		}

		#outputParent {
			position: relative;
			width: calc(100vw - 50px);
			margin: 150px 25px;
			height: 80px;
			border: 2px solid #333;
		}

		#outputParent>#outputSquare {
			position:absolute;
			top: 10px;
			left: 10px;
			width: calc(100vw - 70px); /* 初期値として */
			height: 60px;
			background-color: #0f0;
		}

		#outputParent>#outputPercent {
			font-family: "7segFont", monospace;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 1.5em;
		}

		#settings {
			text-align: left;
			position: relative;
			background-color: #cef;
			margin: auto 30px;
			padding: 30px;
			padding-top: 40px;
			border: none;
			border-radius: 15px;
			line-height: 1.3em;
		}

		#settings>legend {
			position: absolute;
			top: 0;
			translate: 0 -50%;
			background-color: #adf;
			padding: 3px 7px;
			border-radius: 7px;
			font-size: 20px;
		}
	</style>
</head>
<body>
	<h1 id="title">
		<select id="timeFor">
			<option value="0">来年</option>
			<option value="1">来月</option>
			<option value="2">明日</option>
			<option value="3">次の時間</option>
			<option value="4">次の分</option>
			<option value="5">次の秒</option>
		</select>
		まであと
	</h1>
	<div id="outputParent">
		<div id="outputSquare"></div>
		<span id="outputPercent"></span>
	</div>
	<fieldset id="settings">
		<legend>設定</legend>
		
		<span>色の変化<br>
			<!-- <label>中央の色を使う<input type="checkbox"></label> -->
			<cl-pickr id="minColor" data-default-color="#f00" data-opacity="false"></cl-pickr>
			＜
			<cl-pickr id="middleColor" data-default-color="#ff0"></cl-pickr>
			＜
			<cl-pickr id="maxColor" data-default-color="#0f0"></cl-pickr>
		</span>
	</fieldset>
	<script>
		/** idから要素を取得します。
		 * @param {string} id 要素のID
		 * @return {HTMLElement} 取得された要素
		 */
		function el(id) {return document.getElementById(id)};
		/** 新しいPickrを作成します。
		 * @class
		 * @param {string} id Pickrを設置する要素のID
		 * @param {string} defaultColor Pickrの初期色
		 * @param {boolean} opacity 透明度バーを表示するかどうか
		 * @return {Pickr} 作成されたPickrオブジェクト
		 */
		function PickrClass(id, defaultColor, opacity=false) {
			const newPickr = Pickr.create({
				el: "#" + id,
				theme: "monolith",
				default: defaultColor,
				swatches: [
					"#000000",
					"#ffffff",
					"#ff0000",
					"#00ff00",
					"#0000ff",
					"#ffff00",
					"#00ffff",
					"#ff00ff"
				],
				components: {
					// 主要なパネル部分
					preview: true,  // 色プレビュー
					opacity: opacity, // 透明度バー
					hue: true,      // 色相バー

					// 下部の入力・操作部分
					interaction: {
						hex: true,    // HEX形式表示
						rgba: true,   // RGBA形式表示
						input: true,  // 入力ボックス
						clear: false, // クリアボタン
						save: true    // 保存ボタン
					}
				}
			});
			newPickr.on("hide", instance => instance.applyColor());
			return newPickr;
		};

		let pickrs = {};

		class pickrEl extends HTMLElement {
			constructor() {
				super();
			}
			connectedCallback() {
				pickrs[this.id] = new PickrClass(this.id, this.dataset.defaultColor, this.dataset.opacity==="true");
				pickrs[this.id].on("change", (color, instance) => {
					percentUpdate();
				});
			}
		};
		customElements.define("cl-pickr", pickrEl);

		// 	ここまでPickr関連のコード

		let now = [ // 今の時間(nowUpdate関数で更新する)
			null, // year
			null, // month
			null, // day
			null, // hour
			null, // minute
			null, // second
			null  // millisecond
		];
		const CARRY_VALUE = [ // 秒を分に、時間を日に繰り上げるときの引く数
			null,
			12,
			null, // 月によって変わるので別で計算する
			12,
			60,
			60,
			1000
		];
		let updateInterval = 1000; // 更新間隔 (ms)

		/** 2つの色を指定した比率で混ぜた色を返します。
		 * @param {string(rgb)} color1 色1 (例: "rgb(255, 0, 0)")
		 * @param {string(rgb)} color2 色2 (例: "rgb(0, 0, 255)")
		 * @param {number(0~1)} ratio 色1の比率
		 * @return {string(rgb)} 混ぜた色 (例: "rgb(127, 0, 127)")
		 */
		function colorBlend(color1="rgb(,,)", color2="rgb(,,)", ratio) {
			const result = [];
			color1 = color1.split("(")[1].split(")")[0].split(",").map(Number);
			color2 = color2.split("(")[1].split(")")[0].split(",").map(Number);
			for(let i=0;i<3;i++) {
				result[i] = color1[i] * ratio + color2[i] * (1-ratio);
			};
			return `rgb(${result[0]}, ${result[1]}, ${result[2]})`;
		};

		function squareUpdate(percent) {
			const square = el("outputSquare");
			square.style.width = `calc((100vw - 70px) * ${percent})`;
			el("outputPercent").textContent = `${(percent*100).toFixed(2)}%`;
			if(percent < 0.5) {
				el("outputSquare").style.backgroundColor = colorBlend(
					pickrs.middleColor.getColor().toRGBA().toString(),
					pickrs.minColor.getColor().toRGBA().toString(),
					percent * 2
				);
			} else {
				el("outputSquare").style.backgroundColor = colorBlend(
					pickrs.maxColor.getColor().toRGBA().toString(),
					pickrs.middleColor.getColor().toRGBA().toString(),
					(percent - 0.5) * 2
				);
			}
		};

		function nowUpdate() {
			const acquiredDate = new Date();
			now[0] = acquiredDate.getFullYear();
			now[1] = acquiredDate.getMonth() + 1;
			now[2] = acquiredDate.getDate();
			now[3] = acquiredDate.getHours();
			now[4] = acquiredDate.getMinutes();
			now[5] = acquiredDate.getSeconds();
			now[6] = acquiredDate.getMilliseconds();
		};

		function percentUpdate() {
			const timeFor = Number(el("timeFor").value) + 1;
			const timeForM6 = 6 - timeFor;
			nowUpdate();
			for(let i=0;i<timeForM6;i++) {
				now[5-i] += now[6-i]/CARRY_VALUE[6-i];
			};
			now[timeFor] /= CARRY_VALUE[timeFor]; // "/="なんか中々使わない
			now[timeFor] = 1 - now[timeFor];
			squareUpdate(now[timeFor]);
		};

		let update = setInterval(percentUpdate, updateInterval);
	</script>
</body>
</html>