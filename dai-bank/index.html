<!DOCTYPE html>
<html lang="jp">
<head>
	<meta charset="UTF-8">

	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-G3VRHWGPB7"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-G3VRHWGPB7');
	</script>

	<title>大銀行(仮)</title>
	<style>
		@font-face {
			font-family: "originalFont";
			src: url(/0_data/fonts/MPLUS1p-Regular.ttf) format("truetype");
		}

		* {
			text-align: center;
			font-family: "originalFont", sans-serif;
		}

		:disabled {filter: grayscale(100%);}

		#title>span {font-size: 0.75em;}

		body {background-color: #def;}

		button {
			background-color: #3bf;
			color: white;
			font-size: 1.5em;
			padding: 7px 10px;
			border: none;
			border-radius: 20px;
			cursor: pointer;
		}

		#menu {
			margin: 20px auto;
			padding: 10px;
			width: 90%;
			max-width: 600px;
			background-color: #fff;
			border-radius: 10px;
		}

		#menu>div>* {
			margin: 10px 20px;
		}

		#menu #loginMenu {
			margin: auto;
			border-radius: 20px;
			padding: 20px;
			width: min(500px, 50%);
		}

		#loginOutput {
			display: block;
			margin-top: 10px;
		}

		#loginModal {
			border: 2px solid #333;
			border-radius: 10px;
			padding: 20px;
			text-align: center;
		}

		#loginModal>h1 {
			font-size: 1.5em
		}

		#loginModal hr {
			border: none;
		}

		#loginModal>form>label {
			display: block;
			margin: 10px 0;
		}

		#loginModal input:not([type="checkbox"]) {
			border-radius: 3px;
			border: 1.5px solid #777;
			margin-left: 10px;
			text-align: left;
		}

		#closeModal {
			position: absolute;
			top: -5px;
			right: -5px;
			background-color: transparent;
			border: none;
			cursor: pointer;
		}

		#loginModalOutput {font-size: .9em;}
	</style>
</head>
<body>
	<h1 id="title">大銀行<span>(仮)</span></h1>
	<p>version test-γ</p>

	<!--
	<div id="testBts" style="background-color: #fff;">
		name="<input id="testName">", password="<input id="testPassword">"<button id="testCreAccount" style="margin: auto 20px;">アカウント作成(test)</button>
		<br>
		name="<input id="testLoginName">", password="<input id="testLoginPassword">"<button id="testLogin" style="margin: auto 20px;">ログイン(test)</button>
		<br>
		<button id="testLogout">ログアウト(test)</button>
		<p id="testOutput"></p>
	</div>
	-->

	<div id="menu">
		<div>
			名前="<input id="testName">", パスワード="<input id="testPassword">"
			<button id="testCreAccount">アカウント作成(test)</button>
			<div id="loginMenu">
				<button id="loginBt">ログイン</button>
				<br>
				<span id="loginOutput"></span>
				<dialog id="loginModal">
					<h1>ログイン</h1>
					<button id="closeModal"><img src="data/close_52dp_666666_FILL0_wght500_GRAD200_opsz48.svg"></button>
					<label>ユーザー名
						<input type="text" id="loginName">
					</label>
					<hr>
					<label>パスワード
						<input type="password" id="loginPassword">
					</label>
					<p id="loginModalOutput">ユーザー名とパスワードを入力してください</p>
					<hr>
					<button id="loginSubmit">ログインする</button>
				</dialog>
			</div>
			<button id="sendMoney">送金する</button>
			<button id="seeHistory">履歴を見る</button>
			<br>
			<button id="gamble">ギャンブルする</button>
		</div>
	</div>
	<script type="module">
		// Firebase App & Firestore をインポート（すべて同じバージョンで統一）
			import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
			import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
			import {
				getFirestore,
				collection,
				addDoc,
				getDocs
			} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

			const firebaseConfig = {
				apiKey: "AIzaSyAjavOCdQ3RN8atXMLjhLK7TfKY3KSRjig",
				authDomain: "dai-bank.firebaseapp.com",
				projectId: "dai-bank",
				storageBucket: "dai-bank.firebasestorage.app",
				messagingSenderId: "257888747834",
				appId: "1:257888747834:web:e0df926bcf298623325003",
				measurementId: "G-SWPVQD3XT7"
			};

			const app = initializeApp(firebaseConfig);
			const analytics = getAnalytics(app);
			const db = getFirestore(app);

			// データを追加する関数
			async function addData(collectionName, data) {
				await addDoc(collection(db, collectionName), data);
			};

			// データを取得する関数
			async function getData() {
				let result = [];
				const querySnapshot = await getDocs(collection(db, "account"));
				querySnapshot.forEach(doc => result.push(doc.data()));
				return result;
			};

			// 外から呼べるようにする
			window.addData = addData;
			window.getData = getData;
	</script>
	<script>
		function el(id) {return document.getElementById(id);}

		function saveCookie(name, value) {
			document.cookie = `${name}=${value}; max-age=${60*60*24*365};`;
		};

		function getCookie(name) {
			const cookies = document.cookie.split("; ");
			for (const c of cookies) {
				const [key, value] = c.split("=");
				if (key === name) {
					return value;
				};
			};
			return null;
		};

		el("loginBt").onclick = () => {
			el("loginModal").showModal();
		};
		el("closeModal").onclick = () => {
			el("loginModal").close();
		};

		if(getCookie("loginName")) {
			el("loginOutput").innerHTML = `${getCookie("loginName")}としてログインしています`
		} else {
			el("loginOutput").innerHTML = "ログインしていません";
			el("sendMoney").disabled = true;
			el("seeHistory").disabled = true;
			el("gamble").disabled = true;
		};

		el("testCreAccount").onclick = async () => {
			await addData("account", {
				name: el("testName").value,
				password: el("testPassword").value
			});
			saveCookie("loginName", el("testName").value);
			el("loginOutput").innerHTML = `${el("testName").value}としてログインしました`;
		};

		el("loginSubmit").onclick = async () => {
			const data = await getData();
			const name = el("loginName").value;
			const password = el("loginPassword").value;
			let found = false;
			for (const doc of data) {
				if (doc.name === name && doc.password === password) {
					found = true;
					break;
				};
			};
			if (found) {
				saveCookie("loginName", name);
				el("loginModal").close();
				el("loginOutput").innerHTML = `${name}としてログインしました`;
			} else {
				el("loginModalOutput").style.color = "red";
				el("loginModalOutput").innerHTML = `ログイン失敗：名前かパスワードが間違っています`;
			};
		};
		el("testLogout").onclick = () => {
			saveCookie("loginName", "");
			el("loginMOdalOutput").style.color = "black";
			el("testOutput").innerHTML = "ログアウトしました";
		};

		el("sendMoney").onclick = () => {

		};
	</script>
</body>
</html>