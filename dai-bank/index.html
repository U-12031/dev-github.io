<!DOCTYPE html>
<html lang="jp">
<head>
	<meta charset="UTF-8">

	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-G3VRHWGPB7"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-G3VRHWGPB7');
	</script>

	<title>大銀行(仮)</title>
	<style>
		@font-face {
			font-family: "originalFont";
			src: url(/0_data/fonts/MPLUS1p-Regular.ttf) format("truetype");
		}

		* {
			text-align: center;
			font-family: "originalFont", sans-serif;
		}

		:disabled {filter: grayscale(100%);}

		#title>span {font-size: 0.75em;}

		body {background-color: #def;}

		button:not(#logoutBt, .closeModal) {
			background-color: #3bf;
			color: white;
			font-size: 1.5em;
			padding: 7px 10px;
			border: none;
			border-radius: 20px;
			cursor: pointer;
			box-shadow: 3px 3px #06c;

			&:hover:not(:disabled) {
				transition: 
					box-shadow .3s,
					translate .3s;
				;
				box-shadow: none !important;
				translate: 2px 2px;
			}
		}

		::backdrop {background-color: rgba(0, 0, 0, 0.5);}

		:modal {
			margin: auto;
			border: none;
			border-radius: 10px;
			padding: 20px;
			text-align: center;
			position: relative;
			box-shadow: 7px 7px #0af;
			overflow: hidden;
		}

		:modal>h1 {
			margin-top: 5px;
			font-size: 1.5em;
		}

		:modal hr {border: none;}

		:modal input:not([type="checkbox"]) {
			border-radius: 3px;
			border: 1.5px solid #777;
			margin-left: 10px;
			text-align: left;
		}

		.closeModal {
			position: absolute;
			top: -5px;
			right: -5px;
			background-color: transparent;
			border: none;
			cursor: pointer;
		}

		#menu {
			margin: 20px auto;
			padding: 10px;
			width: 90%;
			max-width: 600px;
			background-color: #fff;
			border-radius: 10px;
		}

		#menu>div>*:not(:modal) {margin: 10px 20px;}

		#menu #loginMenu {
			margin: auto;
			border-radius: 20px;
			padding: 20px;
			width: min(500px, 50%);
		}

		#loginOutput {
			display: block;
			margin-top: 10px;
		}

		#logoutBt {
			border-radius: 10px;
			border: none;
			background-color: #d33;
			color: white;
			cursor: pointer;

			&:hover {
				transition: 
					background-color .3s,
					color .3s;
				background-color: #fcc;
				color: #a00;
			}
		}

		#loginModalOutput {font-size: .9em;}

		#logoutModal>h1 {
			font-size: 1.3em;
			margin: auto 20px;
		}

		#logoutModal>button {
			margin: 20px 10px 0 10px;
			font-size: 1.2em;
			border: none;
			border-radius: 15px;
			cursor: pointer;
		}

		#sendMoneyOutput>span {display: block;}

		#sendAmountOutput {color: red;}
	</style>
</head>
<body>
	<h1 id="title">大銀行<span>(仮)</span></h1>
	<p>version test-γ</p>

	<div id="menu">
		<div>
			名前="<input id="testName">", パスワード="<input id="testPassword">"
			<button id="testCreAccount">アカウント作成(test)</button>
			<div id="loginMenu">
				<button id="loginBt">ログイン</button>
				<br>
				<span id="loginOutput"></span>
				<button id="logoutBt">ログアウト</button>
				<dialog id="loginModal">
					<h1>ログイン</h1>
					<img class="closeModal" src="data/close_52dp_666666_FILL0_wght500_GRAD200_opsz48.svg">
					<label>ユーザー名
						<input type="text" id="loginName">
					</label>
					<hr>
					<label>パスワード
						<input type="password" id="loginPassword">
					</label>
					<p id="loginModalOutput">ユーザー名とパスワードを入力してください</p>
					<hr>
					<button id="loginSubmit">ログインする</button>
				</dialog>
				<dialog id="logoutModal">
					<h1>ログアウトしますか？</h1>
					<img class="closeModal" src="data/close_52dp_666666_FILL0_wght500_GRAD200_opsz48.svg">
					<button id="logoutNo">いいえ</button>
					<button id="logoutYes">はい</button>
				</dialog>
			</div>
			<button id="sendMoney">送金する</button>
			<dialog id="sendMoneyModal">
				<h1>送金</h1>
				<img class="closeModal" src="data/close_52dp_666666_FILL0_wght500_GRAD200_opsz48.svg">
				<label>送金先ユーザー名
					<input type="text" id="sendToName">
				</label>
				<hr>
				<label>送金額
					<input type="number" id="sendAmount" min="1">
				</label>
				<p id="sendMoneyOutput">
					<span id="sendToNameOutput">正しいユーザーネームと送金額を入力してください</span>
					<span id="sendAmountOutput"></span>
				</p>
				<hr>
				<button id="sendConfirm" disabled>送金する</button>
			</dialog>
			<button id="seeHistory">履歴を見る</button>
			<br>
			<button id="gamble">ギャンブルする</button>
		</div>
	</div>
	<script type="module">
		// Firebase App & Firestore をインポート（すべて同じバージョンで統一）
		import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
		import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
		import {
			getFirestore,
			collection,
			addDoc,
			getDocs
		} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

		const firebaseConfig = {
			apiKey: "AIzaSyAjavOCdQ3RN8atXMLjhLK7TfKY3KSRjig",
			authDomain: "dai-bank.firebaseapp.com",
			projectId: "dai-bank",
			storageBucket: "dai-bank.firebasestorage.app",
			messagingSenderId: "257888747834",
			appId: "1:257888747834:web:e0df926bcf298623325003",
			measurementId: "G-SWPVQD3XT7"
		};

		const app = initializeApp(firebaseConfig);
		const analytics = getAnalytics(app);
		const db = getFirestore(app);

		/** データを追加する関数
		 * @param {string} collectionName コレクション名
		 * @param {Object} data 追加するデータ 
		*/
		async function addData(collectionName, data) {
			await addDoc(collection(db, collectionName), data);
		};

		/** データを取得する関数
		 * @param {string} collectionName コレクション名
		 * @returns {Array} 取得したデータの配列
		*/
		async function getData(collectionName) {
			let result = [];
			const querySnapshot = await getDocs(collection(db, collectionName));
			querySnapshot.forEach(doc => result.push(doc.data()));
			return result;
		};

		/** idで要素を取得する関数
		 * @param {string} id 要素のid
		 * @returns {HTMLElement} 取得した要素
		*/
		function el(id) {return document.getElementById(id);}

		/** cookieを保存する関数  保存期間は1年
		 * @param {string} name cookieの名前
		 * @param {string} value cookieの値
		*/
		function saveCookie(name, value) {
			document.cookie = `${name}=${value}; max-age=${60*60*24*365};`;
		};

		/** cookieを取得する関数
		 * @param {string} name cookieの名前
		 * @returns {string|null} 取得したcookieの値 ない場合はnull
		*/
		function getCookie(name) {
			const cookies = document.cookie.split("; ");
			for (const c of cookies) {
				const [key, value] = c.split("=");
				if (key === name) {
					return value;
				};
			};
			return null;
		};

		function disableBts(disable = true) {
			// el("sendMoney").disabled = disable;
			el("seeHistory").disabled = disable;
			el("gamble").disabled = disable;
			el("logoutBt").style.display = disable ? "none" : "initial";
		};

		// modalの閉じるボタン
		document.querySelectorAll(".closeModal").forEach(bt => {
			bt.onclick = () => bt.parentElement.close();
		});

		// 起動時のログイン状態確認
		if(getCookie("loginName")) {
			el("loginOutput").innerHTML = `${getCookie("loginName")}としてログインしています`;
			disableBts(false);
		} else {
			el("loginOutput").innerHTML = "ログインしていません";
			disableBts(true);
		};

		// アカウント作成(test用)
		el("testCreAccount").onclick = async () => {
			await addData("account", {
				name: el("testName").value,
				password: el("testPassword").value
			});
			saveCookie("loginName", el("testName").value);
			el("loginOutput").innerHTML = `${el("testName").value}としてログインしました`;
			disableBts(false);
		};

		// ログイン
		el("loginBt").onclick = () => {
			el("loginModal").showModal();
		};
		el("loginSubmit").onclick = async () => {
			const data = await getData("account");
			const name = el("loginName").value;
			const password = el("loginPassword").value;
			let found = false;
			for (const doc of data) {
				if (doc.name === name && doc.password === password) {
					found = true;
					break;
				};
			};
			if (found) {
				saveCookie("loginName", name);
				el("loginModal").close();
				el("loginOutput").innerHTML = `${name}としてログインしました`;
				disableBts(false);
			} else {
				el("loginModalOutput").style.color = "red";
				el("loginModalOutput").innerHTML = `ログイン失敗：名前かパスワードが間違っています`;
				disableBts(true);
			};
		};

		// ログアウト
		el("logoutBt").onclick = () => {
			el("logoutModal").showModal();
		};
		el("logoutYes").onclick = () => {
			el("logoutModal").close();
			saveCookie("loginName", "");
			el("loginOutput").style.color = "black";
			el("loginOutput").innerHTML = "ログアウトしました";
			disableBts(true);
		};
		el("logoutNo").onclick = () => {
			el("logoutModal").close();
		};

		// 送金機能
		el("sendMoney").onclick = () => {
			el("sendToNameOutput").innerHTML = "正しいユーザーネームと送金額を入力してください";
			el("sendAmountOutput").innerHTML = "";
			el("sendMoneyModal").showModal();
		};
		el("sendToName").oninput = async function() {
			const data = await getData("account");
			let value = el("sendToName").value;
			const output = el("sendToNameOutput");
			output.style.color = "red";
			el("sendConfirm").disabled = true;
			if(value === getCookie("loginName")) {
				output.innerHTML = "自分自身には送金できません";
			} else if(value == "") {
				output.innerHTML = "ユーザーネームを入力してください";
			} else if(!(data.find(el => el.name === value))) {
				output.innerHTML = "送金先ユーザー名が見つかりません";
			} else {
				output.style.color = "black";
				if(el("sendAmountOutput").innerHTML === "送金金額は有効です") {
					el("sendConfirm").disabled = false;
				};
				output.innerHTML = "送金先ユーザー名は有効です";
			};
		};
		el("sendAmount").oninput = () => {
			const value = Number(el("sendAmount").value);
			const output = el("sendAmountOutput");
			output.style.color = "red";
			el("sendConfirm").disabled = true;
			/*
			if(el("sendToName").value === "") {
				el("sendToNameOutput").innerHTML = "正しいユーザーネームと送金額を入力してください";
				output.innerHTML = "";
			} else 
			*/
			if(isNaN(value) || value <= 0) {
				output.innerHTML = "送金金額は1以上の数字で入力してください";
			} else {
				output.style.color = "black";
				if(el("sendToNameOutput").innerHTML === "送金先ユーザー名は有効です") {
					el("sendConfirm").disabled = false;
				};
				output.innerHTML = "送金金額は有効です";
			};
		};
		el("sendConfirm").onclick = async () => { 
			const sendFrom = (await getData("account")).find(el => el.name === getCookie("loginName"));
			const sendTo = (await getData("account")).find(el => el.name === el("sendToName").value);
		};
	</script>
</body>
</html>